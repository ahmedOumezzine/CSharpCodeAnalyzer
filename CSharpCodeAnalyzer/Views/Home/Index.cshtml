@{
    ViewData["Title"] = "Analyseur de Code C#";

    var result = ViewBag.Result as CodeAnalyzer.Core.Models.AnalysisResult;
    var formattedCode = result?.FormattedCode ?? "";
    var issues = new List<CodeAnalyzer.Core.Models.RuleResult>();

    if (result != null)
    {
        issues = result.Categories
            .SelectMany(c => c.Issues.Where(i => !i.Passed && !string.IsNullOrEmpty(i.CodeSnippet)))
            .GroupBy(i => i.CodeSnippet)
            .Select(g => g.First())
            .OrderByDescending(i => i.CodeSnippet.Length)
            .ToList();
    }

    string GetSuggestion(CodeAnalyzer.Core.Models.RuleResult issue)
    {
        if (string.IsNullOrEmpty(issue.CodeSnippet)) return "";

        if (issue.RuleName.Contains("PascalCase") || issue.RuleName.Contains("majuscule"))
            return char.ToUpper(issue.CodeSnippet[0]) + issue.CodeSnippet.Substring(1);
        if (issue.RuleName.Contains("camelCase") || issue.RuleName.Contains("minuscule"))
            return char.ToLower(issue.CodeSnippet[0]) + issue.CodeSnippet.Substring(1);
        if (issue.RuleName.Contains("p"))
            return "_" + char.ToLower(issue.CodeSnippet[1]) + issue.CodeSnippet.Substring(2);

        return issue.CodeSnippet;
    }
}

<div class="container mt-5">
    <div class="text-center mb-4">
        <h1 class="display-5"><i class="fas fa-code"></i> Analyseur de Code C#</h1>
        <p class="lead">Collez votre code C#. Cliquez sur un mot erroné pour corriger.</p>
    </div>

    <!-- Formulaire -->
    <form asp-action="Analyze" method="post">
        <div class="card">
            <div class="card-body">
                <label for="sourceCode" class="form-label">Code C# à analyser</label>
                <textarea name="sourceCode"
                          id="sourceCode"
                          rows="10"
                          class="form-control font-monospace"
                          placeholder="Collez votre code C# ici...">@ViewBag.SourceCode</textarea>
            </div>
            <div class="card-footer text-end">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-search"></i> Analyser le Code
                </button>
            </div>
        </div>
    </form>

    @if (result != null && !string.IsNullOrEmpty(formattedCode))
    {
        var displayCode = Html.Encode(formattedCode);

        foreach (var issue in issues)
        {
            var snippet = Html.Encode(issue.CodeSnippet);
            var suggestion = GetSuggestion(issue);
            var encodedSuggestion = Html.Encode(suggestion);
            var replacement = $"<span class=\"error-word\" data-current=\"{snippet}\" data-suggestion=\"{encodedSuggestion}\" style=\"background-color:#ffebee;border-bottom:2px solid #f44336;cursor:pointer;\" title=\"Cliquez pour corriger\">{snippet}</span>";

            displayCode = System.Text.RegularExpressions.Regex.Replace(
            displayCode,
            @"\b" + System.Text.RegularExpressions.Regex.Escape(snippet) + @"\b",
            replacement
            );
        }

        <div class="row mt-4">
            <!-- Code Formaté -->
            <div class="col-12 col-lg-7 mb-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-file-code"></i> Code Formaté</h5>
                    </div>
                    <div class="card-body p-3">
                        <pre id="formattedCode" class="border p-3 bg-light mb-0"
                             style="font-family: 'Courier New', monospace; white-space: pre; line-height: 1.6;">
    @Html.Raw(displayCode)
                            </pre>
                    </div>
                </div>
            </div>

            <!-- Table des erreurs -->
            <div class="col-12 col-lg-5">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Erreurs détectées</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Total :</strong> <span class="badge bg-danger">@result.TotalIssues</span></p>

                        @if (result.TotalIssues == 0)
                        {
                            <div class="alert alert-success">✅ Aucune erreur</div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Mot</th>
                                            <th>Suggestion</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var issue in issues)
                                        {
                                            var suggestion = GetSuggestion(issue);
                                            <tr>
                                                <td><code>@issue.CodeSnippet</code></td>
                                                <td><code>@suggestion</code></td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-success fix-btn"
                                                            data-current="@issue.CodeSnippet"
                                                            data-suggestion="@suggestion">
                                                        ✅ Corriger
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Popup -->
<div id="errorPopup" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">🔧 Corriger l'erreur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Remplacer</strong> <code id="popupCurrent"></code> <strong>par</strong> <code id="popupNew"></code> ?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" id="applyFix">Appliquer</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Code actuel (formaté)
    let currentCode = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(formattedCode));

    // Fonction pour ouvrir le popup
    function openFixPopup(current, suggestion) {
        console.log("Ouverture popup:", { current, suggestion }); // 🔍 Debug

        const popupCurrent = document.getElementById('popupCurrent');
        const popupNew = document.getElementById('popupNew');

        if (!popupCurrent || !popupNew) {
            console.error("Popup éléments non trouvés");
            return;
        }

        popupCurrent.textContent = current;
        popupNew.textContent = suggestion;

        const applyFixBtn = document.getElementById('applyFix');
        if (applyFixBtn) {
            applyFixBtn.onclick = function () {
                console.log("Correction:", current, "→", suggestion);
                currentCode = currentCode.replace(current, suggestion);
                updateDisplay();
                const modal = bootstrap.Modal.getInstance(document.getElementById('errorPopup'));
                modal.hide();
            };
        }

        const modalElement = document.getElementById('errorPopup');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            console.error("Modal #errorPopup non trouvé");
        }
    }

    // Mettre à jour l'affichage
    function updateDisplay() {
        let displayCode = currentCode;

        @foreach (var issue in issues)
        {
                var current = HtmlEncoder.Encode(issue.CodeSnippet);
                var suggestion = HtmlEncoder.Encode(GetSuggestion(issue));
                var replacement = $"<span class=\"error-word\" data-current=\"{current}\" data-suggestion=\"{suggestion}\" style=\"background-color:#ffebee;border-bottom:2px solid #f44336;cursor:pointer;\">{current}</span>";
                <text>
                const regex = new RegExp("\\b" + current + "\\b", "g");
                displayCode = displayCode.replace(regex, "@replacement");
                </text>
        }

        const container = document.getElementById('formattedCode');
        if (container) {
            container.innerHTML = displayCode;
            attachEventListeners(); // 🔁 Réattacher les événements
        }
    }

    // Attacher les événements
    function attachEventListeners() {
        console.log("Attaching event listeners..."); // 🔍 Debug

        // Clic sur mot souligné
        document.querySelectorAll('.error-word').forEach(el => {
            el.removeEventListener('click', null); // Nettoyer
            el.addEventListener('click', function () {
                const current = this.getAttribute('data-current');
                const suggestion = this.getAttribute('data-suggestion');
                if (current && suggestion) {
                    openFixPopup(current, suggestion);
                } else {
                    console.warn("Données manquantes:", { current, suggestion });
                }
            });
        });

        // Clic sur bouton "Corriger"
        document.querySelectorAll('.fix-btn').forEach(btn => {
            btn.removeEventListener('click', null);
            btn.addEventListener('click', function () {
                const current = this.getAttribute('data-current');
                const suggestion = this.getAttribute('data-suggestion');
                if (current && suggestion) {
                    openFixPopup(current, suggestion);
                }
            });
        });
    }

    // Attendre que le DOM soit chargé
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOM chargé, initialisation..."); // ✅
        attachEventListeners();
    });
</script>

<style>
    .error-word:hover {
        background-color: #ffcdd2 !important;
    }
</style>